--- ixp_osal/Makefile	1970-01-01 00:00:00.000000000 +0000
+++ ixp_osal/Makefile	1970-01-01 00:00:00.000000000 +0000
@@ -297,9 +297,9 @@ endif
 else # IX_TARGET_OS == vxworks
 # linux compiler flags 
 MAKE_DEP_FLAG := -M
-LINUX_MACH_CFLAGS := -D__LINUX_ARM_ARCH__=5 -mcpu=xscale -mtune=xscale
+LINUX_MACH_CFLAGS := -D__LINUX_ARM_ARCH__=5 -mtune=xscale
 
-CFLAGS := -D__KERNEL__ -I$(LINUX_SRC)/include -Wall -Wno-trigraphs -fno-common -pipe -mapcs-32 -mshort-load-bytes -msoft-float -DMODULE -Isrc/include -D__linux -DCPU=33 -DXSCALE=33 $(LINUX_MACH_CFLAGS)
+CFLAGS := -D__KERNEL__ -I$(LINUX_SRC)/include -Wall -Wno-trigraphs -fno-common -pipe -mapcs-32 -msoft-float -DMODULE -Isrc/include -D__linux -DCPU=33 -DXSCALE=33 $(LINUX_MACH_CFLAGS)
 ifndef IX_INCLUDE_MICROCODE
 CFLAGS += -DIX_NPEDL_READ_MICROCODE_FROM_FILE
 endif
@@ -867,9 +867,11 @@ $(NPE_DAT) : $(NPE_CONVERTER)
 
 ifeq ($(IX_HOST_OS),linux)
 ifndef IX_INCLUDE_MICROCODE
+ifdef IX_BUILD_MICROCODE
 Makefile: $(NPE_CONVERTER) $(NPE_DAT)
 endif
 endif
+endif
 
 ################################################################
 # Rules to check that macros are defined.
@@ -1321,10 +1323,26 @@ ixp400.o : $(OBJ_DIR)/ixp400.o
 
 ifndef IX_INCLUDE_MICROCODE
 $(OBJ_DIR)/ixp400.o: $(COMPONENTS:%=$(OBJ_DIR)/ixp400_%.o) $(OSAL_MODULE)
+	rm -f $(OBJ_DIR)/ixp400.c
+	touch $(OBJ_DIR)/ixp400.c
+	cp Makefile.kmod26 $(OBJ_DIR)/Makefile
+	make -C $(OBJ_DIR)
+	rm -f $(OBJ_DIR)/ixp400.c
+	cp ixp400.c $(OBJ_DIR)/ixp400.c
 	$(LD) $(LDFLAGS) $^ -o $@
+	rm -f $(OBJ_DIR)/ixp400.ko $(OBJ_DIR)/ixp400.mod.o
+	make -C $(OBJ_DIR)
 else
 $(OBJ_DIR)/ixp400.o: $(COMPONENTS:%=$(OBJ_DIR)/ixp400_%.o) $(NPE_PRODUCTION_HEADER_OBJ) $(OSAL_MODULE)
+	rm -f $(OBJ_DIR)/ixp400.c
+	touch $(OBJ_DIR)/ixp400.c
+	cp Makefile.kmod26 $(OBJ_DIR)/Makefile
+	make -C $(OBJ_DIR)
+	rm -f $(OBJ_DIR)/ixp400.c
+	cp ixp400.c $(OBJ_DIR)/ixp400.c
 	$(LD) $(LDFLAGS) $^ -o $@
+	rm -f $(OBJ_DIR)/ixp400.ko $(OBJ_DIR)/ixp400.mod.o
+	make -C $(OBJ_DIR)
 endif
 
 
--- ixp_osal/ixp400.c	1970-01-01 00:00:00.000000000 +0000
+++ ixp_osal/ixp400.c	1970-01-01 00:00:00.000000000 +0000
@@ -0,0 +1,1 @@
+#error this file must never be compiled
--- ixp_osal/Makefile.kmod26	1970-01-01 00:00:00.000000000 +0000
+++ ixp_osal/Makefile.kmod26	1970-01-01 00:00:00.000000000 +0000
@@ -0,0 +1,11 @@
+obj-m := ixp400.o
+
+PWD         := $(shell pwd)
+
+LINUX_SRC := $($(IX_TARGET)_KERNEL_DIR)
+
+default:
+	$(MAKE) ARCH=arm CROSS_COMPILE=$(LINUX_CROSS_COMPILE) $(KERNEL_VERBOSE) -C $(LINUX_SRC) SUBDIRS=$(PWD) modules
+
+clean:
+	rm -f ixp400.ko
